# Observability

In this section, we will learn how to observe the fleets with [IBM Cloud Monitoring](https://cloud.ibm.com/observability/monitoring) and [IBM Cloud Logs](https://cloud.ibm.com/observability/logging).

## Monitor your fleets' data

You can use the IBM Cloud Monitoring service to monitor your Code Engine workloads. Code Engine forwards selected information about your workloads to an IBM Cloud Monitoring instance of your choice so that you can observe specific metrics such as memory and CPU utilization of your fleet workers.

1. Got to https://cloud.ibm.com/observability/monitoring

    * Alternatively, use the navigation menu to go to the Monitoring instances page: **☰ > Observability > Monitoring**.

    ![](./images/30-cloud-nav-monitoring.png ':size=800')

2. From the list of monitoring instances click the Dashboard link of the monitoring instance that corresponds to your lab; e.g. `fleetlab-user1--sysdig`.

    ![](./images/30-monitoring-instances.png ':size=800')

3. Once the monitoring user interface had been loaded, navigate to **Dashboards > Host infrastructure > Host Resource Usage** using the fly-out menu rendered on the left side of the screen.

    ![](./images/30-monitoring-dashboards.png ':size=800')

4. The dashboard already renders some information. However, we'll further customize it and tailor it to fleets. Click **Copy to My Dashboards** in the top-right corner of the screen.

    ![](./images/30-monitoring-dashboard-host-resource-usage-default.png ':size=800')

5. As a new name for the dashboard chose `Code Engine Fleets - Worker Resource Usage`. Click **Create and Open**.

    ![](./images/30-monitoring-create-dashboard.png ':size=300')

6. To customize the dashboard click the pencil icon that is rendered below the dashboard title

    ![](./images/30-monitoring-customize-dashboard.png ':size=800')

7. In the drop down called **Select a label**, type `agent_tag_project_region` and hit return to create the additional filter.

    * Repeat this procedure for `agent_tag_project_name` and `agent_tag_fleet`.

    ![](./images/30-monitoring-dashboard-add-filter.png ':size=800')

8. Review the list of newly added filters and click **Save**

    ![](./images/30-monitoring-dashboard-save-filters.png ':size=800')

9. View the charts and data provided by the dashboard:
    * **Filtering** allows to drill into a specific region, Code Engine project, fleet name and worker name.
    * **Timeframe** configuration allows to observe what is currently running, as well as to go back in time to analyze previous fleet runs.
    * **CPU** usage of each Code Engine fleet worker.
    * **Memory** usage of each Code Engine fleet worker.
    * **Swap** usage of each Code Engine fleet worker.
    * **Disk** usage of each Code Engine fleet worker, by revealing available disk space, file IOPS and Inodes usage.
    * **Network** usage of each Code Engine fleet worker, by revealing the transmitted network bytes and number of network connections.
    ![](./images/30-monitoring-worker-usage-dashboard.png ':size=800')

?> **Please Note** As you can see in the Monitoring dashboard, the fleet that processes PDF documents using Docling uses way more resources than the simple helloworld fleet. Observing and analyzing the CPU and memory utilization of your fleet workers from time to time is essential to make sure that the configured task resources, as well as concurrency are matching the workload requirements.

## View your fleets' logs

You can use the IBM Cloud Logs service to access the log lines your Code Engine workloads. Code Engine forwards all log records that are generated by your workloads to an IBM Cloud Logs instance of your choice so that you can gain insights into the execution of your soure code. Besides those "user-generated" log lines, Code Engine also published log lines that provide useful details to gain insights into the system; e.g. duration of image pulls, or log messages that announce completed tasks.

1. Got to https://cloud.ibm.com/observability/logging

    * Alternatively, use the navigation menu to go to the Logging instances page: **☰ > Observability > Logging**.

    ![](./images/30-cloud-nav-logging.png ':size=800')

2. From the list of logging instances click the Dashboard link of the logging instance that corresponds to your lab; e.g. `fleetlab-user1--icl`.

    ![](./images/30-logging-instances.png ':size=800')

3. Once the logging user interface had been loaded, navigate to **Logs** using the fly-out menu rendered on the left side of the screen.

    ![](./images/30-logging-logs-view.png ':size=800')

4. First, let us extend the timeframe for which logs are being shown, by clicking on **Last 15 minutes** in the top-right corner. From the selection choose **Last 1 hour**.

    ![](./images/30-logging-configure-timeframe.png ':size=800')

5. Now, the the list is filled with quite some logs, let us improve the readability by adjusting the columns of the Logs view. Click the **Columns** button that is rendered on the right-hand side of the table header.

    ![](./images/30-logging-configure-columns.png ':size=800')

6. Adjust the columns
   * Remove all entries in the right column except for **Timestamp**
   * Drag and drop the following columns from the left to the right:
      * `codeengine.component`
      * `codeengine.subcomponentType`
      * `codeengine.subcomponent`
      * `message.message` 
   * Click **Apply**
    ![](./images/30-logging-new-columns.png ':size=400')

7. Now, the actual lines are readable, let us adjust the Logs view by adding useful filters. Click the **Add filter** button that is rendered on the left-hand side of the page.

![](./images/30-logging-configure-filters.png ':size=800')

8. Add more filters 
    * By typing the property name in the search field and selecting it from the result list rendered below
    ![](./images/30-logging-new-filters.png ':size=800')
    * Add filters for
      * `codeengine.component`
      * `originator`
    ![](./images/30-logging-filter-for-user-logs.png ':size=800')

9. Now, that we've finalized the logs view, let us save it so that we re-use it for all Code Engine workloads that are coming.
    * Click the three dots next to `Unsaved view` in the top-left corner of the Logs view
    ![](./images/30-logging-saving-three-dots.png ':size=800')
    * Give this customized logs view a name, like `Code Engine - Fleets` and choose `Public` as **Privacy settings**
    * Click **Create**
    ![](./images/30-logging-saving.png ':size=800')

10. Now, let us inspect the log lines of a specific docling PDF conversion. For that we'll want to filter for a specific task instances. Furthermore, we do want to make sure that only log lines generated by the conversion task itself are shown.
    * In the list of filters in the left side panel, scroll to the Originator filter and select `user`
    * In the column `codeengine.subcomponent` click on one of the rendered values, like `000-00000-00000000000000000000` and choose **Include in query** in the rendered context menu
    ![](./images/30-logging-apply-filters.png ':size=800')

11. Inspect the rendered view. Assuming the code would run your source code, the applied filter selection would make sure that only logs lines produced by a single task instance are rendered.

![](./images/30-logging-filtered.png ':size=800')

## Inspect your fleets' task execution

Besides of accessing log records as pure text, IBM Cloud Logs provides advanced features that allow to create dashboards and alerts generated out of log records. In this last topic about observability capabilities, we'll import a pre-build dashboard that reveals useful details about the execution of tasks, like their duration and exit code.

1. In Cloud Logs, navigate to **Custom Dashboards** using the fly-out menu rendered on the left side of the screen.

    ![](./images/30-dashboards-menu.png ':size=800')

2. Download the following file to your local workstation: <a href="./assets/code_engine_fleets_-_system_insights.json" target="_blank" download="code_engine_fleets_-_system_insights.json">code_engine_fleets_-_system_insights.json</a>

3. In the rendered empty dashboard click **New** and select **Import dashboard**.

    ![](./images/30-dashboards-new-import.png ':size=800')

4. Select the downloaded file and complete the modal by clicking **Import**

    ![](./images/30-dashboards-import-modal.png ':size=400')
    ![](./images/30-dashboards-import-modal-confirm.png ':size=400')

5. The rendered dashboard display information about the number of processed tasks, their duration, their result and exit code. Furthermore, the dashboard can be used to gain insights about the duration of image pulls.

    ![](./images/30-dashboards-overview.png ':size=800')

6. Now, lets run another fleet that will launch tasks that are not as homogenous as the past ones.
    * Open a new browser tab and go to https://cloud.ibm.com/containers/serverless/overview
        * Alternatively, use the navigation menu to go to the Code Engine Overview page: **☰ > Containers > Serverless > Get started**.
    * As shown in the previous steps, set following configuration
        * **Name**: `<your-username>-crashing-fleet`
        * **Code > Container image reference**: `icr.io/codeengine/helloworld`
        * **Tasks > Number of tasks**: `500`
        * **Tasks > Task state store**: `fleet-task-store`
        * **Resource & scaling > vCPU per instance**: `0.5`
        * **Resource & scaling > Memory per instance**: `1 GB`
        * **Resource & scaling > Max number of concurrent instances**: `10`
        * **Resource & scaling > Max retries per task**: `0`
        * **Environment variables**
            * Add a variable of type **Literal value**, called `SUCCESS_RATE` with the value `0.9`
            * Add a variable of type **Literal value**, called `SLEEP` with the value `RANDOM` 
        * Click **Create**
    ![](./images/30-dashboards-crashing_fleet.png ':size=800')

7. Switch back to the browser tab that contains the dashboard. 
    * In the top-right corner switch the timeframe to "Last 1 hour".
    * Set the automatic refresh interval to **2m**.
    ![](./images/30-dashboards-time-selector.png ':size=800')

8. Observe the fleet for some time and take a look at the various graphs. Play around with them and discover their configuration.
    * How to visualize the p95 duration of all tasks? 
    * How to filter the dashboard for a specific fleet name?
    * ...
    ![](./images/30-dashboards-observe.png ':size=800')


?> **Congratulations!** In this section you'learned how to observe memory and CPU utlization, how to watch the performance of the task execution, and how to filter for log records created by your custom code in case you'll need to troubleshoot a problem. Having said that, you are well prepared to run your code on IBM Cloud Code Engine.


⇨ [More to discover](60-more-to-discover.md)